# 支付系统



## 一、小程序支付

### 1.1 小程序登录

官方文档

`https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html`



![image-20211219124715803](https://bclz_xc.gitee.io/lilj_01-static/pay/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%99%BB%E5%BD%95%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3.jpg)





### 1.2 JSAPI支付 文档 微信官方

`https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_1`



### 1.3 创建微信支付订单的流程

![image-20211219124715803](https://bclz_xc.gitee.io/lilj_01-static/pay/%E5%88%9B%E5%BB%BA%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E8%AE%A2%E5%8D%95%E7%9A%84%E6%B5%81%E7%A8%8B.jpg)

### 1.4 创建支付订单必备的参数



![image-20211219124715803](https://bclz_xc.gitee.io/lilj_01-static/pay/%E5%88%9B%E5%BB%BA%E6%94%AF%E4%BB%98%E8%AE%A2%E5%8D%95%E5%BF%85%E5%A4%87%E7%9A%84%E5%8F%82%E6%95%B0-%E5%9B%BE1.jpg)

![image-20211219124715803](https://bclz_xc.gitee.io/lilj_01-static/pay/%E5%88%9B%E5%BB%BA%E6%94%AF%E4%BB%98%E8%AE%A2%E5%8D%95%E5%BF%85%E5%A4%87%E7%9A%84%E5%8F%82%E6%95%B0-%E5%9B%BE2.jpg)



### 1.5官方skd地址

`https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=11_1`



商户为小程序生成数字证书，否则小程序要集成。

```java
    /**
     * 生成数字签名
     *
     * @param prepayId 微信平台支付订单id
     * @return 响应给小程序（否则需要小程序生成）
     */
    private R generateDigitalSignature(String prepayId) {
        Map<String, String> signParamsMap = new HashMap<>();
        String timeStamp = new Date().getTime() + "";
        String nonceStr = WXPayUtil.generateNonceStr();
        signParamsMap.put("appId", appId);
        signParamsMap.put("timeStamp", timeStamp);
        signParamsMap.put("nonceStr", nonceStr);
        signParamsMap.put("package", "prepay_id=" + prepayId);
        signParamsMap.put("signType", "MD5");
        try {
            String paySign = WXPayUtil.generateSignature(signParamsMap, key);
            Map<String, Object> resultMap = new HashMap<>();
            resultMap.put("package", "prepay_id=" + prepayId);
            resultMap.put("timeStamp", timeStamp);
            resultMap.put("nonceStr", nonceStr);
            resultMap.put("paySign", paySign);
            return R.ok(resultMap);
        } catch (Exception e) {
            return R.error(e.getMessage());
        }
    }
```



### 1.6 微信平台用户确认支付后时序图

![](https://bclz_xc.gitee.io/lilj_01-static/pay/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%A1%AE%E8%AE%A4%E6%94%AF%E4%BB%98%E6%B5%81%E7%A8%8B.png)



